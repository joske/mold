file(GLOB TESTS
  RELATIVE ${CMAKE_CURRENT_LIST_DIR}
  CONFIGURE_DEPENDS
  "*.sh")

foreach(TEST IN LISTS TESTS)
  string(REGEX REPLACE "\\.sh$" "" TESTNAME ${TEST})

  add_test(NAME "${CMAKE_HOST_SYSTEM_PROCESSOR}-${TESTNAME}"
    COMMAND bash -x ${CMAKE_CURRENT_LIST_DIR}/${TEST}
    WORKING_DIRECTORY ${mold_BINARY_DIR})

  set_tests_properties("${CMAKE_HOST_SYSTEM_PROCESSOR}-${TESTNAME}" PROPERTIES
    ENVIRONMENT "ARCH=${CMAKE_HOST_SYSTEM_PROCESSOR}")

  if(${CMAKE_HOST_SYSTEM_PROCESSOR} STREQUAL "arm64")
    add_test(NAME "x86_64-${TESTNAME}"
      COMMAND bash -x ${CMAKE_CURRENT_LIST_DIR}/${TEST}
      WORKING_DIRECTORY ${mold_BINARY_DIR})

    set_tests_properties("x86_64-${TESTNAME}" PROPERTIES
      ENVIRONMENT "ARCH=x86_64")
  endif()
endforeach()
